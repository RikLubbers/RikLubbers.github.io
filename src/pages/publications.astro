---
import Layout from '../layouts/Layout.astro';
import PublicationItem from '../components/PublicationItem.astro';
import { getCollection } from 'astro:content';

const derivedStatus = (entry: any) => { // Using any to access legacy/untyped fields if necessary
  const t = (entry.data.type || '').toLowerCase();
  const v = (entry.data.venue || '').toLowerCase();
  const n = (entry.data.note || '').toLowerCase(); // Fallback for legacy notes

  if (v.includes('under review') || n.includes('under review')) return 'Under Review';
  if (v.includes('submitted') || n.includes('submitted')) return 'Submitted';
  if (t === 'preprint' || v.includes('preprint') || n.includes('preprint')) return 'Preprint';
  if (v.includes('in press') || n.includes('in press')) return 'In press';
  
  return 'Published';
};

const statusPriority: Record<string, number> = {
  'Under Review': 0,
  'Submitted': 1,
  'Preprint': 2,
  'In press': 3,
  'Published': 4
};

const allPapers = (await getCollection('publications')).sort((a, b) => {
  // 1. Sort by Year (Descending)
  const timeDiff = b.data.year - a.data.year;
  if (timeDiff !== 0) return timeDiff;

  // 2. Sort by Status Priority (Ascending order of importance index)
  const statusA = derivedStatus(a);
  const statusB = derivedStatus(b);
  
  return (statusPriority[statusA] ?? 99) - (statusPriority[statusB] ?? 99);
});
const years = [...new Set(allPapers.map(p => p.data.year))];
---

<Layout title="Publications">
  <div class="max-w-4xl mx-auto px-4 py-12 sm:py-20">
    <div class="mb-10">
      <h1 class="text-4xl font-bold text-gray-900 mb-4">Publications</h1>
      <p class="text-lg text-gray-600 mb-8">
        Peer reviewed publications, preprints, and manuscripts.
      </p>

      <!-- Client-side Filters -->
      <div class="flex flex-wrap gap-2" id="pub-filters">
        <button class="filter-btn active px-4 py-2 rounded-full text-sm font-medium bg-gray-900 text-white transition-all hover:bg-gray-800" data-filter="All">
          All
        </button>
        <button class="filter-btn px-4 py-2 rounded-full text-sm font-medium bg-gray-100 text-gray-600 hover:bg-gray-200 transition-all border border-gray-200" data-filter="Published">
          Published
        </button>
        <button class="filter-btn px-4 py-2 rounded-full text-sm font-medium bg-gray-100 text-gray-600 hover:bg-gray-200 transition-all border border-gray-200" data-filter="Preprint">
          Preprint
        </button>
        <button class="filter-btn px-4 py-2 rounded-full text-sm font-medium bg-gray-100 text-gray-600 hover:bg-gray-200 transition-all border border-gray-200" data-filter="Under Review">
          Under Review
        </button>
        <button class="filter-btn px-4 py-2 rounded-full text-sm font-medium bg-gray-100 text-gray-600 hover:bg-gray-200 transition-all border border-gray-200" data-filter="Submitted">
          Submitted
        </button>
      </div>
    </div>

    <div class="grid lg:grid-cols-[140px_1fr] gap-12 items-start mt-12">
      
      <!-- Sticky Year Sidebar -->
      <aside class="hidden lg:block sticky top-24">
        <nav class="space-y-2">
          {years.map(year => (
            <a href={`#year-${year}`} class="toc-link block text-sm font-medium text-gray-500 hover:text-blue-600 transition-colors py-1 border-l-2 border-transparent hover:border-blue-200 pl-3">
              {year}
            </a>
          ))}
        </nav>
      </aside>

      <div class="space-y-16 min-w-0" id="pub-list">
        {years.map(year => (
          <section id={`year-${year}`} class="relative group-year scroll-mt-24" data-year={year} data-toc-section>
            <div class="flex items-center gap-4 mb-6">
              <h2 class="text-3xl font-bold text-gray-900">{year}</h2>
              <div class="h-px bg-gray-100 flex-grow"></div>
            </div>
            <div class="space-y-4">
              {allPapers.filter(p => p.data.year === year).map(paper => (
                <PublicationItem entry={paper} />
              ))}
            </div>
          </section>
        ))}
        
        {allPapers.length === 0 && (
          <p class="text-gray-500 text-center py-12">No publications found. Add markdown files to src/content/publications/</p>
        )}
      </div>
    </div>
  </div>

  <script>
    // Simple Client-Side Filtering
    document.addEventListener('astro:page-load', () => {
      const filters = document.querySelectorAll('.filter-btn');
      const items = document.querySelectorAll('.card-refined[data-status]');
      const yearGroups = document.querySelectorAll('.group-year');

      filters.forEach(btn => {
        btn.addEventListener('click', () => {
          // 1. Update Active State
          filters.forEach(f => {
             f.classList.remove('bg-gray-900', 'text-white');
             f.classList.add('bg-gray-100', 'text-gray-600');
          });
          btn.classList.remove('bg-gray-100', 'text-gray-600');
          btn.classList.add('bg-gray-900', 'text-white');

          const filterValue = btn.getAttribute('data-filter');

          // 2. Filter Items
          items.forEach(item => {
             const status = item.getAttribute('data-status');
             if (filterValue === 'All' || status === filterValue) {
               item.style.display = 'block';
             } else {
               item.style.display = 'none';
             }
          });

          // 3. Hide Empty Years
          yearGroups.forEach(group => {
             const visibleItems = group.querySelectorAll('.card-refined[data-status][style="display: block"], .card-refined[data-status]:not([style*="display: none"])');
             if (visibleItems.length > 0) {
               group.style.display = 'block';
             } else {
               group.style.display = 'none';
             }
          });
        });
      });
    });
  </script>

  <script>
    // Scroll Spy Logic
    document.addEventListener('astro:page-load', () => {
      const sections = document.querySelectorAll('[data-toc-section]');
      const links = document.querySelectorAll('.toc-link');

      if (sections.length > 0 && links.length > 0) {
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const id = entry.target.getAttribute('id');
              // Remove active from all
              links.forEach(link => {
                 link.classList.remove('toc-active');
                 link.removeAttribute('aria-current');
              });
              // Add active to current
              const activeLink = document.querySelector(`.toc-link[href="#${id}"]`);
              if (activeLink) {
                activeLink.classList.add('toc-active');
                activeLink.setAttribute('aria-current', 'true');
                
                // Update URL hash without scroll (debounced)
                if (history.replaceState) {
                   history.replaceState(null, null, `#${id}`);
                }
              }
            }
          });
        }, {
          rootMargin: "-20% 0px -60% 0px", // Key to centering the trigger zone
          threshold: 0
        });

        sections.forEach(section => observer.observe(section));
      }
    });
  </script>
</Layout>
