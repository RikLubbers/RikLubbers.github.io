---
import { FileText, Github, Play, MonitorPlay, Video, ExternalLink, Globe, Sparkles, BookOpen, Calendar, Tag } from 'lucide-react';
import type { CollectionEntry } from 'astro:content';

interface Props {
  entry: CollectionEntry<'publications'>;
}

const { entry } = Astro.props;
const { title, authors, year, venue, links, award, badges } = entry.data;

const iconMap: Record<string, any> = {
  pdf: FileText,
  code: Github,
  demo: Play,
  slides: MonitorPlay,
  video: Video,
  website: Globe,
  doi: ExternalLink,
};

// Strict Badge Logic
// 1. Explicit badges from frontmatter take precedence if they exist (though we aim to derive)
// 2. Derive based on fields
let status = 'Published'; // Default
let statusColor = 'green';

const t = entry.data.type || '';
const v = (entry.data.venue || '').toLowerCase();
const unsafeData = entry.data as any;
const n = (unsafeData.note || '').toLowerCase();

if (t === 'preprint' || v.includes('preprint') || n.includes('preprint')) {
  status = 'Preprint';
  statusColor = 'gray';
} else if (v.includes('under review') || n.includes('under review')) {
  status = 'Under Review';
  statusColor = 'gold'; // Using gold/yellow
} else if (v.includes('submitted') || n.includes('submitted')) {
  status = 'Submitted';
  statusColor = 'blue';
} else {
  status = 'Published';
  statusColor = 'green';
}

const badgeStyles: Record<string, string> = {
  gold: "bg-amber-50 text-amber-700 border-amber-200",
  blue: "bg-blue-50 text-blue-700 border-blue-200",
  green: "bg-emerald-50 text-emerald-700 border-emerald-200",
  gray: "bg-gray-100 text-gray-700 border-gray-200", 
};

// Helper to format link label
const formatLabel = (key: string) => {
  if (key === 'pdf') return 'PDF';
  if (key === 'github') return 'Code';
  if (key === 'website') return 'Project';
  return key.charAt(0).toUpperCase() + key.slice(1);
};
---

<div class="card-refined p-6 mb-4 group relative" data-status={status}>
  
  {/* Primary Click Overlay */}
  {links?.pdf && <a href={links.pdf} target="_blank" rel="noopener noreferrer" class="card-link" aria-label={`Read ${title}`}></a>}
  {!links?.pdf && links?.doi && <a href={`https://doi.org/${entry.data.doi}`} target="_blank" rel="noopener noreferrer" class="card-link" aria-label={`Read ${title}`}></a>}
  
  <div class="flex flex-col gap-3 relative z-20 pointer-events-none">
    
    <!-- Title -->
    <h3 class="text-xl font-bold text-gray-900 leading-tight group-hover:text-blue-600 transition-colors pointer-events-auto">
      {entry.data.doi ? <a href={`https://doi.org/${entry.data.doi}`} target="_blank" rel="noopener noreferrer" class="inner-link">{title}</a> : (links?.website ? <a href={links.website} target="_blank" rel="noopener noreferrer" class="inner-link">{title}</a> : (links?.pdf ? <a href={links.pdf} target="_blank" rel="noopener noreferrer" class="inner-link">{title}</a> : title))}
    </h3>

    <!-- Metadata Chips -->
    <div class="flex flex-wrap items-center gap-3 text-sm pointer-events-auto">
      {/* Venue */}
      {venue && (
        <span class="inline-flex items-center gap-1.5 font-medium text-gray-700 bg-gray-50 px-2.5 py-0.5 rounded-md border border-gray-200">
          <BookOpen class="w-3.5 h-3.5 text-gray-500" />
          {venue}
        </span>
      )}
      
      {/* Year */}
      <span class="inline-flex items-center gap-1.5 font-medium text-gray-600 bg-gray-50 px-2.5 py-0.5 rounded-md border border-gray-200">
        <Calendar class="w-3.5 h-3.5 text-gray-500" />
        {year}
      </span>

      {/* Status Badge */}
      <span class={`inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-xs font-semibold border ${badgeStyles[statusColor]}`}>
         <Tag class="w-3 h-3 opacity-70" />
         {status}
      </span>
      
      {/* Award Badge (Legacy) */}
      {award && (
        <span class="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full bg-amber-50 text-amber-700 text-xs font-semibold border border-amber-200">
          <Sparkles class="w-3 h-3" /> {award}
        </span>
      )}
    </div>

    <!-- Authors -->
    <div class="text-gray-600 leading-relaxed text-[15px] pointer-events-auto">
      {authors.map((author, index) => (
        <>
          {author.includes("Lubbers") ? (
            <strong class="font-bold text-gray-900 underline decoration-blue-200 decoration-2 underline-offset-2">{author}</strong>
          ) : (
             author
          )}
          {index < authors.length - 1 && ", "}
        </>
      ))}
    </div>

    <!-- Links / DOI (Quick Actions) -->
    <div class="flex flex-wrap gap-3 pt-2 pointer-events-auto">
      {/* DOI */}
      {entry.data.doi && (
         <a 
           href={`https://doi.org/${entry.data.doi}`}
           target="_blank"
           class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-semibold text-gray-700 border border-gray-200 rounded-lg hover:text-blue-700 hover:border-blue-300 hover:bg-blue-50 transition-all bg-white shadow-sm"
         >
           <ExternalLink className="w-3.5 h-3.5 text-gray-400 group-hover/btn:text-blue-500" />
           DOI
         </a>
      )}

      {/* Other Links */}
      {links && Object.entries(links).map(([key, url]) => {
          if (!url || url === '#' || key === 'doi') return null; 
          const Icon = iconMap[key] || ExternalLink;
          return (
            <a 
              href={url}
              target="_blank"
              class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-semibold text-gray-600 border border-gray-200 rounded-lg hover:text-blue-600 hover:border-blue-200 hover:bg-blue-50 transition-all bg-white shadow-sm"
            >
              <Icon className="w-3.5 h-3.5 text-gray-400" />
              {formatLabel(key)}
            </a>
          );
      })}
    </div>
  </div>
</div>
